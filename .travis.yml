language: cpp

addons:
  apt:
    packages:
      - cmake
      - g++-6
      - gcc-6
      - lcov
    sources:
      - kalakris-cmake
      - ubuntu-toolchain-r-test

install:
- if [ "$CXX" = "g++" ]; then export CXX="g++-6" CC="gcc-6"; fi
- gem install coveralls-lcov

script:
- g++-6 -g -O0 -fprofile-arcs -ftest-coverage hw.cpp
- lcov --zerocounters --directory $TRAVIS_BUILD_DIR/
- lcov --gcov-tool /usr/bin/gcov-6 --capture --initial --directory $TRAVIS_BUILD_DIR/ --output-file coverage.info
- ./a.out
- lcov --help
- lcov --gcov-tool /usr/bin/gcov-6 --no-checksum --no-compat-libtool --directory $TRAVIS_BUILD_DIR/ --capture --output-file coverage.info
- lcov --gcov-tool /usr/bin/gcov-6 --remove coverage.info 'tests/*' '/usr/*' --output-file coverage.info
- lcov --gcov-tool /usr/bin/gcov-6 --list coverage.info
- cmake ./llama_cpp/benchmark/google_benchmark
- make
- mkdir -p ../benchmark_llama_cpp
- mkdir -p ../benchmark_llama_cpp/src
- cp ./src/libbenchmark.a ../benchmark_llama_cpp/src/libbenchmark.a
- ./build/build_cpp.sh all
- lcov --zerocounters --directory $TRAVIS_BUILD_DIR/../build_llama_cpp
- ./build/build_cpp.sh all coverage
- pushd ./llama_java
- ./gradlew assemble
- popd

after_success:
- pushd ../build_llama_cpp
- lcov --gcov-tool /usr/bin/gcov-6 --no-checksum --directory $TRAVIS_BUILD_DIR/../build_llama_cpp --capture --output-file coverage.info
- lcov --gcov-tool /usr/bin/gcov-6 --remove coverage.info 'tests/*' '/usr/*' --output-file coverage.info
- lcov --gcov-tool /usr/bin/gcov-6 --list coverage.info
- popd
- coveralls-lcov --repo-token ${COVERALLS_REPO_TOKEN} ../build_llama_cpp/coverage.info

compiler: g++

sudo: required
